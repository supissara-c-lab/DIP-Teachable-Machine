<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mask Detection System - Health & Safety</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2D6A4F">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/883/883360.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('PWA: พร้อมใช้งาน!'))
            .catch(err => console.log('PWA: ลงทะเบียนไม่สำเร็จ', err));
        });
      }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');

        :root {
            --primary-green: #2D6A4F;
            --medical-green: #40916C;
            --light-green: #D8F3DC;
            --warning-red: #D90429;
        }

        body {
            margin: 0;
            font-family: 'Sarabun', sans-serif;
            background-color: #F8F9FA;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            width: 100%;
            padding: 20px 0;
            background-color: var(--primary-green);
            color: white;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .main-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            text-align: center;
            width: 90%;
            max-width: 450px;
        }

        .camera-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px;
        }

        #webcam-container {
            width: 100%;
            height: 100%;
            border: 4px solid var(--light-green);
            border-radius: 15px;
            overflow: hidden;
            background-color: #f1f1f1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        .switch-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--medical-green); }
        input:checked + .slider:before { transform: translateX(18px); }

        #result-display {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            border: 2px solid #eee;
            transition: 0.3s;
            min-height: 50px;
        }

        .status-safe { background-color: #E8F5E9; color: #1B5E20; border-color: #C8E6C9 !important; }
        .status-danger { background-color: #FFEBEE; color: #B71C1C; border-color: #FFCDD2 !important; }

        .accuracy-bar { font-size: 14px; color: #666; margin-top: 5px; font-weight: 400; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; font-size: 24px;">ระบบตรวจคัดกรองการสวมหน้ากากอนามัย</h1>
        <p style="margin:5px 0 0; opacity: 0.9;">AI Mask Detection System</p>
    </div>

    <div class="main-card">
        <div class="camera-wrapper">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="camera-toggle" onchange="toggleCamera()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="webcam-container">
                <span id="placeholder-text" style="color: #999;">กล้องกำลังปิด</span>
            </div>
        </div>

        <div id="result-display" style="display: none;">
            <span id="status-text">กำลังวิเคราะห์ข้อมูล...</span>
            <div id="accuracy" class="accuracy-bar"></div>
        </div>
    </div>

    <script type="text/javascript">
        const URL = "./"; 
        let model, webcam, resultDisplay, statusText, accuracyText, animationId;
        let isCameraOpen = false;

        async function toggleCamera() {
            const toggle = document.getElementById('camera-toggle');
            const placeholder = document.getElementById('placeholder-text');

            if (toggle.checked) {
                placeholder.innerHTML = "กำลังโหลด...";
                await startSystem();
                isCameraOpen = true;
            } else {
                stopSystem();
                placeholder.innerHTML = "กล้องกำลังปิด";
                isCameraOpen = false;
            }
        }

        async function startSystem() {
            try {
                if (!model) {
                    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                }
                
                webcam = new tmImage.Webcam(300, 300, true); 
                await webcam.setup(); 
                await webcam.play();

                document.getElementById("webcam-container").innerHTML = "";
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                
                resultDisplay = document.getElementById("result-display");
                statusText = document.getElementById("status-text");
                accuracyText = document.getElementById("accuracy");
                resultDisplay.style.display = "block";

                animationId = window.requestAnimationFrame(loop);
            } catch (err) {
                console.error(err);
                alert("ไม่สามารถเข้าถึงกล้องได้");
                document.getElementById('camera-toggle').checked = false;
            }
        }

        function stopSystem() {
            if (webcam) { webcam.stop(); }
            if (animationId) { window.cancelAnimationFrame(animationId); }
            document.getElementById("webcam-container").innerHTML = 
            '<span id="placeholder-text" style="color: #999;">กล้องกำลังปิด</span>';
            document.getElementById("result-display").style.display = "none";
        }

        async function loop() {
            webcam.update(); 
            await predict();
            animationId = window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            const noMaskProb = prediction[0].probability;
            const maskProb = prediction[1].probability;

            if (maskProb > 0.6) {
                statusText.innerHTML = "ตรวจพบการสวมหน้ากาก";
                resultDisplay.className = "status-safe";
                accuracyText.innerHTML = `ความแม่นยำ: ${(maskProb * 100).toFixed(0)}%`;
            } else if (noMaskProb > 0.6) {
                statusText.innerHTML = "ไม่พบการสวมหน้ากาก";
                resultDisplay.className = "status-danger";
                accuracyText.innerHTML = `ความแม่นยำ: ${(noMaskProb * 100).toFixed(0)}%`;
            } else {
                statusText.innerHTML = "กำลังวิเคราะห์ใบหน้า...";
                resultDisplay.className = "";
                accuracyText.innerHTML = "";
            }
        }
    </script>
</body>
</html>